# Israeli Bank Importer - Docker Compose Production Setup
#
# Usage:
#   docker compose up -d                              Start in background
#   docker compose logs -f                             Follow logs
#   docker compose down                                Stop
#   docker compose pull && docker compose up -d        Update to latest
#
# Prerequisites:
#   - config.json in the same directory (see config.json.example)
#   - Actual Budget server running and accessible

services:
  importer:
    image: sergienko4/israeli-bank-importer:latest
    container_name: israeli-bank-importer
    restart: unless-stopped
    cap_drop:
      - ALL                # Drop all capabilities first
    cap_add:
      - SYS_ADMIN          # Required for Chromium sandboxing
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /dev/shm:size=256m       # Chromium shared memory
    deploy:
      resources:
        limits:
          memory: 2g
          cpus: '1.5'
    environment:
      - TZ=Asia/Jerusalem
      # Cron schedule: run every 8 hours (at midnight, 8am, 4pm)
      # Remove SCHEDULE to run once and exit
      - SCHEDULE=0 */8 * * *
    volumes:
      - ./config.json:/app/config.json:ro   # Read-only config (credentials)
      - importer-data:/app/data             # Actual Budget sync data
      - importer-cache:/app/cache           # App cache
      - importer-chrome:/app/chrome-data    # Browser session (2FA persistence)
    healthcheck:
      test: ["CMD", "ps", "aux"]
      interval: 5m
      timeout: 10s
      start_period: 30s
      retries: 3

# Named volumes for data persistence (survive container recreation)
volumes:
  importer-data:
  importer-cache:
  importer-chrome:
